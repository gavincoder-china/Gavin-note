# åˆ†å¸ƒå¼å¾®æœåŠ¡ä¸“æ 009(springbootä¸­é›†æˆå¾®ä¿¡ç™»å½•[å®Œæ•´,æœ€æ–°,æœ€å…¨] &ngrokå†…ç½‘ç©¿é€)

## â­ï¸(1).å‡†å¤‡å·¥ä½œ

> #### 1ï¸âƒ£ç”³è¯·æµ‹è¯•å·
>
> https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox%2Findex
>
> è®¿é—®è¯¥é“¾æŽ¥,æ‰«ç ç™»å½•ç”³è¯·ä¸€ä¸ªæµ‹è¯•å·(æ­£å¼å·éœ€è¦å…¬å¸è®¤è¯)
>
> 2ï¸âƒ£å®˜æ–¹æ–‡æ¡£åœ°å€  (å®˜æ–¹æ–‡æ¡£ä¸­çš„é“¾æŽ¥å‚æ•°æœ‰é”™,å»ºè®®çœ‹æˆ‘ä¸‹æ–‡åšå®¢)
>
> https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html
>
> 3ï¸âƒ£å‡ ä¸ªæ³¨æ„ç‚¹
>
> åŽé¢éœ€è¦ç™»å½•æµ‹è¯•çš„å¾®ä¿¡,éœ€è¦å…ˆæ‰«ç å…³æ³¨æµ‹è¯•å…¬ä¼—å·
>
> ![image-20191009213353241](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9x2go97j30vv096myc.jpg)
>
> ä½ è‡ªå·±çš„AppID/secret
>
> è¿™è¾¹å¾…ä¼šè¦ç”¨,å…ˆç•™æ„ç€![image-20191009190206151](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s5j5vywmj30wi06ojsi.jpg)
>
> ![image-20191009212148314](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9kkf0y5j30ta0fkmy6.jpg)

## â­ï¸(2).å¾®ä¿¡ç™»å½•çš„æµç¨‹å›¾(å¾ˆé‡è¦,æ¯”å®˜æ–¹æ›´è¯¦ç»†)

![image-20191009191648716](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s5yg2739j31080gaq81.jpg)

## â­ï¸(3).ä¸‰å¤§é‡è¦æŽ¥å£è°ƒç”¨æ‰€éœ€å‚æ•°åŠå…¶è¿”å›žå€¼è§£æž

> ### 1ï¸âƒ£è¯·æ±‚èŽ·å–codeå‚æ•°
>
> é“¾æŽ¥:
>
> ```java
> https://open.weixin.qq.com/connect/oauth2/authorize?    ---->ä¸å˜
> appid=APPID                                             ---->ä½ æµ‹è¯•å·çš„AppID
> &redirect_uri=RedirectUrl                               ---->å¾®ä¿¡å›žè°ƒçš„æ–¹æ³•åœ°å€(ä¸‹é¢è¯¦è§£)
> &response_type=code                                     ---->ä¸å˜
> &scope=snsapi_userinfo                                  ---->ä¸å˜
> &state=STATE                                            ---->ä¸å˜
> #wechat_redirect                                        ---->ä¸å˜
> ```
>
> è¿”å›žå€¼:
>
> ```json
> è¿”å›žä¸€ä¸ªstringç±»åž‹çš„codeå‚æ•°  å¦‚:061Iwfgo1gLnqp0Dffho1G2Ufo1Iwfgu
> ```
>
> 
>
> ### 2ï¸âƒ£è¯·æ±‚access_token&openidç­‰å‚æ•°
>
> é“¾æŽ¥:
>
> ```java
> https://api.weixin.qq.com/sns/oauth2/access_token?      ---->ä¸å˜
> appid=APPID                                             ---->ä½ æµ‹è¯•å·çš„AppID
> &secret=SECRET                                          ---->ä½ æµ‹è¯•å·çš„secret
> &code=CODE                                              ---->ä¸Šé¢æ–¹æ³•è¿”å›žçš„code
> &grant_type=authorization_code                          ---->ä¸å˜
> ```
>
> è¿”å›žå€¼:
>
> ![image-20191009193450061](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s6h78qm4j30p2057myu.jpg)
>
> access_token:ä¸‹é¢è¦ç”¨
>
> openid:ç”¨æˆ·çš„id(å”¯ä¸€,ä¸å˜),ä¸‹é¢èŽ·å–ç”¨æˆ·ä¿¡æ¯éœ€è¦ç”¨,è¿™ä¸ªä¹Ÿå¯ä»¥å½“åšå¾®ä¿¡ç”¨æˆ·è¡¨çš„ä¸»é”®id
>
> expire_in:è¿‡æœŸæ—¶é—´(å•ä½:ç§’),ä¸¤å°æ—¶
>
> ### 3ï¸âƒ£è¯·æ±‚ç”¨æˆ·ä¿¡æ¯
>
> é“¾æŽ¥:
>
> ```java
> https://api.weixin.qq.com/sns/userinfo?                  ---->ä¸å˜
> access_token=access_token                                ---->ä¸Šé¢æ–¹æ³•è¿”å›žçš„access_token
> &openid=openid                                           ---->ä¸Šé¢æ–¹æ³•è¿”å›žçš„openid
> &lang=zh_CN                                              ---->ä¸å˜
> ```
>
> è¿”å›žå€¼:
>
> ![image-20191009194152318](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s6oietr9j30on08740d.jpg)

## â­ï¸(4).ä»£ç ç»“æž„å›¾

![image-20191009204346365](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s8gxw0xbj31100a1tae.jpg)

## â­ï¸(5).ä»£ç å±•ç¤º

> ### 1ï¸âƒ£å¾®ä¿¡ç™»å½•å®žä½“ç±»ä»£ç &é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®å±•ç¤º
>
> ```java
> /**
>  * **********************************************************
>  *
>  * @Project:
>  * @Author : Gavincoder
>  * @Mail : xunyegege@gmail.com
>  * @Github : https://github.com/xunyegege
>  * @ver : version 1.0
>  * @Date : 2019-10-09 10:28
>  * @description:
>  ************************************************************/
> @Component
> @ConfigurationProperties(prefix = "wx")
> @Data
> public class WxLoginModel {
>     //è¯·æ±‚codeçš„åœ°å€
> 
>     private String codeUrl;
> 
>     private String appId;
> 
>     //å¾®ä¿¡å›žè°ƒåœ°å€
>     private String redirectUrl;
> 
>     //ç§˜é’¥
>     private String secret;
> 
>     //è¯·æ±‚toeknçš„åœ°å€
> 
>     private String tokenUrl;
> 
>     //è¯·æ±‚ç”¨æˆ·ä¿¡æ¯çš„åœ°å€
>     
>     private String userInfoUrl;
> 
> 
>     /**
>      * @return java.lang.String
>      * @throws
>      * @description æ‹¼æŽ¥ç”Ÿæˆè¯·æ±‚codeå®Œæ•´é“¾æŽ¥
>      * @author Gavin
>      * @date 2019-10-09 20:47
>      * @since
>      */
>     public String getRealUrl() {
>         //new stringBufferå¯¹è±¡çš„æ—¶å€™å°±æŠŠç¬¬ä¸€ä¸ªéœ€è¦æ‹¼æŽ¥çš„å­—ç¬¦ä¸²åŠ è¿›åŽ»(æ–¹ä¾¿æ“ä½œ)
>         StringBuffer buffer = new StringBuffer(getCodeUrl());
> 
> 
>         String realUrl = buffer
>                 .append("appid=")
>                 .append(getAppId())
>                 .append("&redirect_uri=")
>                 .append(getRedirectUrl())
>                 .append("&response_type=code")
>                 .append("&scope=snsapi_userinfo")
>                 .append("&state=STATE")
>                 .append("#wechat_redirect")
>                 .toString();
>         return realUrl;
>     }
> 
> 
>     /**
>      * @return java.lang.String
>      * @throws
>      * @description æ‹¼æŽ¥ç”Ÿæˆè¯·æ±‚accessToken/openidçš„å®Œæ•´é“¾æŽ¥,å‚æ•°codeç”±ç¬¬ä¸€æ­¥æ–¹æ³•è¿”å›ž
>      * @author Gavin
>      * @date 2019-10-09 20:48
>      * @since
>      */
>     public String getAccessTokenUrl(String code) {
> 
> 
>         StringBuffer buffer = new StringBuffer(getTokenUrl());
>         String tokenUrl = buffer
>                 .append("appid=")
>                 .append(getAppId())
>                 .append("&secret=")
>                 .append(getSecret())
>                 .append("&code=")
>                 .append(code)
>                 .append("&grant_type=authorization_code").toString();
>         return tokenUrl;
>     }
> 
> 
>     /**
>      * @return java.lang.String
>      * @throws
>      * @description æ‹¼æŽ¥ç”Ÿæˆè¯·æ±‚ç”¨æˆ·ä¿¡æ¯çš„å®Œæ•´é“¾æŽ¥, å‚æ•°accessToken/openidç”±ç¬¬äºŒæ­¥æ–¹æ³•è¿”å›ž
>      * @author Gavin
>      * @date 2019-10-09 20:48
>      * @since
>      */
>     public String getUserInfoUrl(String accessToken, String openid) {
> 
>         StringBuffer buffer = new StringBuffer(getUserInfoUrl());
>         String UserInfoUrl = buffer
>                 .append("access_token=")
>                 .append(accessToken)
>                 .append("&openid=").append(openid)
>                 .append("&lang=zh_CN").toString();
> 
>         return UserInfoUrl;
>     }
> 
> 
> }
> ```
>
> ```properties
> #å¾®ä¿¡ç™»å½•ç›¸å…³
> 
> wx.codeUrl=https://open.weixin.qq.com/connect/oauth2/authorize?
> 
> wx.appId=xxxxxxxxxx(å¡«ä½ è‡ªå·±çš„)    
> 
> wx.redirectUrl=https://7292458c.ngrok.io/wx/callBack   (å¡«ä½ è‡ªå·±çš„) --è¿™ä¸ªä¸‹é¢è¯¦è§£
> 
> wx.secret=xxxxxxxxxx(å¡«ä½ è‡ªå·±çš„)    
> 
> wx.tokenUrl=https://api.weixin.qq.com/sns/oauth2/access_token?
> 
> wx.userInfoUrl=https://api.weixin.qq.com/sns/userinfo?
> ```
>
> 2ï¸âƒ£controllerå±‚ä»£ç å±•ç¤º
>
> ```java
> /**
>  * **********************************************************
>  *
>  * @Project:
>  * @Author : Gavincoder
>  * @Mail : xunyegege@gmail.com
>  * @Github : https://github.com/xunyegege
>  * @ver : version 1.0
>  * @Date : 2019-10-09 10:27
>  * @description:
>  ************************************************************/
> 
> @Controller
> @RequestMapping(value = "/wx")
> public class WxController {
> 
>     @Autowired
>     private WxLoginModel wxLoginModel;
> 
> 
>     @GetMapping(value = "/getCode")
>     public String getCode() {
>         
>         //å°†ç”Ÿæˆçš„é“¾æŽ¥è¿”å›žåˆ°å‰ç«¯å¹¶é‡å®šå‘åˆ°é“¾æŽ¥åœ°å€
>         // ä¸ºäº†ä½¿ç”¨redirecté‡å®šå‘æ–¹æ³•,ä¸å¯åŠ ä¸Š@restcontroller  @ResponseBody
>         //è¿™è¾¹ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨äºŒç»´ç ç”Ÿæˆå™¨ç”ŸæˆäºŒç»´ç å›¾åƒè¿›è¡Œæ‰«ç 
>         return "redirect:" + wxLoginModel.getRealUrl();
>     }
> 
> 
>     @GetMapping(value = "/callBack")
>     public String callBack(String code) {
> 
>         //1.ä½¿ç”¨å›žè°ƒä¼ è¿›æ¥çš„codeæ•°æ®è°ƒç”¨ç”Ÿæˆé“¾æŽ¥çš„æ–¹æ³•,èŽ·å–è¯·æ±‚access_token&openidç­‰å‚æ•°çš„é“¾æŽ¥
>         String accessTokenUrl = wxLoginModel.getAccessTokenUrl(code);
> 
>         //2.é€šè¿‡å·¥å…·ç±»å‘èµ·httpè¯·æ±‚å¹¶æŽ¥å—è¿”å›žå€¼
>         String accessTokenUrlJson = UrlUtils.loadURL(accessTokenUrl);
> 
>         //3.ç”±äºŽèŽ·å–åˆ°çš„æ•°æ®æ˜¯jsonå¯¹è±¡æ ¼å¼çš„,æ‰€ä»¥ä½¿ç”¨fastjsonä¸­çš„æ–¹æ³•å°†å…¶è½¬æˆjsonObject
>         JSONObject accessTokenJsonObject = JSONObject.parseObject(accessTokenUrlJson);
>         
>         //4.é€šè¿‡fastjsonçš„getstringæ–¹æ³•æå–è¯¥jsonå¯¹è±¡ä¸­çš„æ•°æ®
>         String accessToken = accessTokenJsonObject.getString("access_token");
>         String openid = accessTokenJsonObject.getString("openid");
> 
>         //5.ä½¿ç”¨èŽ·å–åˆ°çš„æ•°æ®è°ƒç”¨ç”Ÿæˆé“¾æŽ¥çš„æ–¹æ³•,èŽ·å–è¯·æ±‚ç”¨æˆ·ä¿¡æ¯çš„é“¾æŽ¥
>         String userInfoUrl = wxLoginModel.getUserInfoUrl(accessToken, openid);
>         //6.é€šè¿‡å·¥å…·ç±»å‘èµ·httpè¯·æ±‚å¹¶æŽ¥å—è¿”å›žå€¼
>         String userInfoJson = UrlUtils.loadURL(userInfoUrl);
>         //7.åŒä¸Š,è§£æžæ•°æ®,èŽ·å–æ•°æ®,è‡³æ­¤,å¾®ä¿¡ç™»å½•æˆåŠŸ
>         JSONObject userInfoJsonObject = JSONObject.parseObject(userInfoJson);
> 
>         
>         //8.æ‹¿æ•°æ®è¿›è¡Œæ“ä½œ.è¿™è¾¹éšæ„äº†
>         //..........
>         
>         return "éšæ„å†™ä»€ä¹ˆ";
> 
>     }
> 
> 
>     @GetMapping(value = "/happy")
>     @ResponseBody
>     public String happyBirthDay() {
> 
>         //å½©è›‹â¤ï¸
>         return "2019-10-10,ðŸ–æˆ‘äº²çˆ±çš„å¹³å¹³ç”Ÿæ—¥å¿«ä¹â¤ï¸";
>     }
> 
> 
> }
> ```
>
> 3ï¸âƒ£httpè¯·æ±‚å·¥å…·ç±»å±•ç¤º
>
> ```java
> /**
>  * æœ¬ç±»æä¾›äº†å¯¹URLæ‰€æŒ‡å‘çš„å†…å®¹çš„åŠ è½½æ“ä½œ
>  *
>  * @author boot
>  */
> public class UrlUtils {
> 
>     /**
>      * èŽ·å–urlç½‘å€è¿”å›žçš„æ•°æ®å†…å®¹
>      * ç”¨çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±è¡Œ,ä¼ å…¥ä½ éœ€è¦è¯·æ±‚çš„urlé“¾æŽ¥
>      * @param urlStr
>      * @return
>      */
>     public static String loadURL(String urlStr) {
>         try {
>             URL url = new URL(urlStr);
>             HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();
>             urlConnection.setRequestMethod("GET");
>             urlConnection.connect();
>             InputStream inputStream = urlConnection.getInputStream();
>             String responseStr = ConvertToString(inputStream);
>             return responseStr;
>         } catch (IOException e) {
>             e.printStackTrace();
>             return null;
>         }
>     }
> 
>     private static String ConvertToString(InputStream inputStream) {
>         InputStreamReader inputStreamReader = new InputStreamReader(inputStream);
>         BufferedReader bufferedReader = new BufferedReader(inputStreamReader);
>         StringBuilder result = new StringBuilder();
>         String line = null;
>         try {
>             while ((line = bufferedReader.readLine()) != null) {
>                 result.append(line + "\n");
>             }
>         } catch (IOException e) {
>             e.printStackTrace();
>         } finally {
>             try {
>                 inputStreamReader.close();
>                 inputStream.close();
>                 bufferedReader.close();
>             } catch (IOException e) {
>                 e.printStackTrace();
>             }
>         }
>         return result.toString();
>     }
> }
> ```

## â­ï¸(6). redirectUrlé“¾æŽ¥è§£æž&å†…ç½‘ç©¿é€æ–¹æ³•ä»‹ç»

> ###  ðŸŒ¹redirectUrlå‚æ•°
>
> redirectUrlåœ°å€å¡«çš„æ˜¯æˆ‘ä»¬controllerå±‚çš„callBackæ–¹æ³•çš„åœ°å€
>
> è¿™ä¸ªæ˜¯ç»™å¾®ä¿¡ç”¨çš„å›žè°ƒæŽ¥å£.
>
> è§£é‡Š:
>
> æˆ‘ä»¬ç‚¹å‡»ç™»å½•é“¾æŽ¥æˆ–æ‰«ç åŽ,
>
> å¾®ä¿¡éœ€è¦å°†å®ƒç”Ÿæˆçš„æ•°æ®å›žä¼ ç»™æˆ‘ä»¬å¼€å‘è€…çš„åŽç«¯,
>
> è¿™æ—¶å€™å¾®ä¿¡å°±éœ€è¦ä¸€ä¸ªå›žè°ƒæŽ¥å£,
>
> é‚£åœ¨ä¸Šé¢é…ç½®æ–‡ä»¶ä¸­éœ€è¦å¡«çš„å°±æ˜¯æˆ‘ä»¬æ‰€å†™çš„callBackæŽ¥å£æ–¹æ³•çš„åœ°å€
>
> ### ðŸŒ¹ä½¿ç”¨Ngrokè¿›è¡Œå†…ç½‘ç©¿é€
>
> æœ‰ä¸€éƒ¨åˆ†å¼€å‘è€…è·Ÿæˆ‘ä¸€æ ·æ˜¯åœ¨æœ¬æœºä¸Šè¿›è¡Œæ“ä½œçš„,
>
> æˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯å•æœºå†…ç½‘çŽ¯å¢ƒ,
>
> è¦æƒ³è®©å¾®ä¿¡ç«¯è°ƒç”¨åˆ°æˆ‘ä»¬çš„åœ°å€,
>
> å°±éœ€è¦è¿›è¡Œå†…ç½‘ç©¿é€
>
> #### è½¯ä»¶æŽ¨è
>
> https://ngrok.com/download
>
> ä½¿ç”¨æ–¹æ³•
>
> > macä¸‹ä½¿ç”¨
> >
> > ä½¿ç”¨å‘½ä»¤è¡Œç»ˆç«¯,æ¥åˆ°ngrokç›®å½•ä¸‹
> >
> > è¾“å…¥å‘½ä»¤:  
> >
> > ./ngrok http localhost:9004     
> >
> > è¿™è¾¹çš„ç«¯å£å·å¯¹åº”ä½ è‡ªå·±çš„é¡¹ç›®çš„ç«¯å£å·
> >
> > ç”»æ¡†çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„é“¾æŽ¥,æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­
> >
> > ![image-20191009211649162](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9fbp45aj30ih0en75c.jpg)
> >
> > ```java
> > é…ç½®æ–‡ä»¶:  wx.redirectUrl=https://87ef9499.ngrok.io/wx/callBack   
> >           (åŽé¢çš„  /wx/callback  å¯¹åº”ä½ è‡ªå·±é¡¹ç›®ä¸­è‡ªå·±å†™çš„å›žè°ƒå‡½æ•°çš„æŽ¥å£åœ°å€)
> > ```
> >
> > 
>
> > windowsä¸‹è§£åŽ‹åŒå‡»exeæ–‡ä»¶
> >
> > åœ¨è·³å‡ºæ¥çš„å‘½ä»¤ä¸²å£ä¸­è¾“å…¥:
> >
> > ngrok http 8080  è¿™è¾¹çš„ç«¯å£å·å¯¹åº”ä½ è‡ªå·±çš„é¡¹ç›®çš„ç«¯å£å·
> >
> > å…¶ä½™æ“ä½œåŒä¸Š(ä¿®æ”¹é…ç½®æ–‡ä»¶åœ°å€)
>
> ### ðŸŒ¹åœ¨å¾®ä¿¡æµ‹è¯•å·ç½‘é¡µä¸Šè®¾ç½®è‡ªå·±çš„å†…ç½‘ç©¿é€åœ°å€
>
> å‰é¢ä¸è¦åŠ   https://
>
> ![image-20191009212120163](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9k1atu5j30ta0fkmy6.jpg)

## â­ï¸(7).æµ‹è¯•å±•ç¤º

> 1ï¸âƒ£åœ¨åœ°å€æ è¾“å…¥è¯·æ±‚åœ°å€,åœ°å€æ å˜çš„è¿™ä¸ªé“¾æŽ¥,å°±æ˜¯çœŸå®žè¯·æ±‚åœ°å€,å¯ä»¥æ”¾åœ¨å¾®ä¿¡å®¢æˆ·ç«¯æ‰“å¼€
>
> ,ä¹Ÿå¯ä»¥ä½¿ç”¨äºŒç»´ç ç”Ÿæˆå™¨ç”ŸæˆäºŒç»´ç ,è¿›è€Œæ‰«ç ç™»å½•
>
> ![image-20191009212844488](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9rqk7ewj30xc086myf.jpg)
>
> ![image-20191009213020149](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9tdxifnj30ou07gwfn.jpg)
>
> ![image-20191009213106430](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9u6tv52j310n0egjuc.jpg)
>
> 2ï¸âƒ£å¾®ä¿¡ç«¯æç¤ºèŽ·å–ç”¨æˆ·ä¿¡æ¯,ç‚¹å‡»åŒæ„
>
> 3ï¸âƒ£javaç«¯DeBugç»“æžœ,æ‰€æœ‰æ•°æ®å‡å·²èŽ·å¾—
>
> ![image-20191009213244885](https://tva1.sinaimg.cn/large/006y8mN6gy1g7s9vyxrsbj31b50gqaif.jpg)
>
> 